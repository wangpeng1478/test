<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>公告管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="" type="image/x-icon" />
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="https://cdn.bootcss.com/weui/2.0.0/style/weui.min.css">
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div id="app">
        <form action="" @submit.prevent="submit">
            <div class="weui-cells__title">内容</div>
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__bd">
                        <textarea class="weui-textarea" v-model="bulletin.content" placeholder="请输入公告" maxlength="200" rows="3"></textarea>
                        <div class="weui-textarea-counter"><span v-text="bulletin.content.length"></span>/200</div>
                    </div>
                </div>
            </div>
            <div class="weui-btn-area">
                <button class="weui-btn weui-btn_primary" type="submit">添加公告</button>
            </div>
        </form>
    </div>
    <script src="https://cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.js"></script>

    <script src="weui.min.js"></script>
    <script>
        var vue = new Vue({
            el: '#app',
            data: {
                bulletin: {
                    content:'',
                }
            },
            methods: {
                get(type) {
                    var vm = this;
                    var loading = weui.loading('loading');
                    $.post('https://api.it120.cc/cfce0392be2649cb5375a66472d6a2b6/json/list', {
                        type: type
                    }, function (re) {
                        console.log(re)
                        if (re.code === 0 && re.data.length != 0) {
                            
                            vm.id = re.data[0].id;
                            vm.bulletin.content = re.data[0].jsonData.content;
                        } else {
                            weui.alert(re.msg||'请添加公告');
                        }
                        loading.hide();
                    });
                },
                submit() {
                    var vm = this;
                    var data = this.bulletin;
                    if (!data.content) {
                        weui.alert('输入内容');
                    } else {
                        var setData = {
                            content: JSON.stringify(data),
                            type: 'bulletin'
                        };
                        if(vm.id){
                            setData.id = vm.id;
                        }
                        var loading = weui.loading('提交中');
                        $.post('https://api.it120.cc/cfce0392be2649cb5375a66472d6a2b6/json/set', setData,
                            function (re) {
                                if (re.code === 0) {
                                    weui.toast('成功');
                                } else {
                                    weui.alert(re.msg);
                                }
                                vm.id = 0;
                                loading.hide();
                            });
                    }

                }
            },
            mounted() {
                this.get('bulletin')
            },
        })
    </script>
</body>

</html>