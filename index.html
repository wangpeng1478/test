<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="utf-8">
    <title>AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="shortcut icon" href="" type="image/x-icon" />
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="weui.min.css">
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://res.wx.qq.com/open/libs/weuijs/1.0.0/weui.min.js"></script>
</head>

<body>
    <div class="page__bd">
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell">
                <div class="weui-cell__bd">
                    <div class="weui-uploader">
                        <div class="weui-uploader__hd">
                            <p class="weui-uploader__title">Face++</p>
                        </div>
                        <div class="weui-uploader__bd">
                            <div class="weui-uploader__input-box">
                                <input class="weui-uploader__input" type="file" id="file" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <img id="Base64" src="" alt="" height="100">
    <div class="weui-cells__title">结果</div>
    <select>
        <option value="volvo" style="display:none;">display:none</option>
        <option value="saab" disabled>disabled</option>
        <option value="saab" hidden>hidden</option>
    </select>
    <div id="ocrbody">
    </div>
    <script>
    var app = {
        data: {
            name: 'app',
            imgBase64: '',
        },
        initial: function initial() {
            console.log(this.data.name)
            this.Base64();
        },
        Base64: function Base64() {
            var vm = this;
            var eleFile = document.querySelector('#file');
            // 压缩图片需要的一些元素和对象
            var reader = new FileReader(),
                img = new Image();
            // 选择的文件对象
            var file = null;
            // 缩放图片需要的canvas
            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');

            // base64地址图片加载完毕后
            img.onload = function() {
                // 图片原始尺寸
                var originWidth = this.width;
                var originHeight = this.height;
                // 最大尺寸限制
                var maxWidth = 800,
                    maxHeight = 800;
                // 目标尺寸
                var targetWidth = originWidth,
                    targetHeight = originHeight;
                // 图片尺寸超过400x400的限制
                if (originWidth > maxWidth || originHeight > maxHeight) {
                    if (originWidth / originHeight > maxWidth / maxHeight) {
                        // 更宽，按照宽度限定尺寸
                        targetWidth = maxWidth;
                        targetHeight = Math.round(maxWidth * (originHeight / originWidth));
                    } else {
                        targetHeight = maxHeight;
                        targetWidth = Math.round(maxHeight * (originWidth / originHeight));
                    }
                }

                // canvas对图片进行缩放
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                // 清除画布
                context.clearRect(0, 0, targetWidth, targetHeight);
                // 图片压缩
                context.drawImage(img, 0, 0, targetWidth, targetHeight);
                var dataURL = canvas.toDataURL("image/png"); //压缩后的base64
                document.querySelector('#Base64').src = dataURL
                // vm.AI(dataURL)
                // canvas转为blob并上传
                canvas.toBlob(function(blob) {
                    // console.log(blob)
                    // // 图片ajax上传
                    // var xhr = new XMLHttpRequest();
                    // // 文件上传成功
                    // xhr.onreadystatechange = function() {
                    //     if (xhr.status == 200) {
                    //         // xhr.responseText就是返回的数据
                    //     }
                    // };
                    // // 开始上传
                    // xhr.open("POST", 'upload.php', true);
                    // xhr.send(blob);
                }, file.type || 'image/png');
            };

            // 文件base64化，以便获知图片原始尺寸
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            eleFile.addEventListener('change', function(event) {
                var loading = weui.loading('识别中...', {
                    className: 'custom-classname'
                });
                file = event.target.files[0];
                // 选择的文件是图片
                if (file.type.indexOf("image") == 0) {
                    reader.readAsDataURL(file);
                }
            });
        },
        AI: function AI(img) {
            $.ajax({
                type: 'post',
                url: 'https://api-cn.faceplusplus.com/cardpp/v1/ocridcard',
                data: {
                    api_key: 'Y9NV1C_caxzytLml2DSLP-RMhQ9CAPfq',
                    api_secret: '0Zqs_EJheNmw7twjjDk3XLzRP8QaXTmY',
                    image_base64: img,
                },
                dataType: 'json',
                beforeSend: function(xhr, settings) {
                    // console.log(settings)
                },
                success: function(data, status, xhr) {
                    if (status == "success") {
                        console.log(data)
                        $('#ocrbody').html('');
                        if (data.cards.length == 0) {
                            weui.topTips('识别错误');
                        } else {
                            weui.toast('识别成功');
                            var d = data.cards[0]
                            for (var i in d) {
                                $('#ocrbody').append('<div class="weui-cell weui-cell_access">' +
                                    '                 <div class="weui-cell__bd">' + i + '</div>' +
                                    '                 <div class="weui-cell__ft">' +
                                    '                    <span>' + d[i] + '</span>' +
                                    '                </div>' +
                                    '            </div>')
                            }
                        }

                    } else {
                        weui.topTips('Ajax error!')
                    }
                    $('.custom-classname').remove()
                },
                error: function(xhr, type) {
                    weui.topTips('Ajax error!')
                    $('.custom-classname').remove()
                }
            })
        }
    }
    </script>
    <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone"></a><a href="#" class="bds_tsina" data-cmd="tsina"></a><a href="#" class="bds_tqq" data-cmd="tqq"></a><a href="#" class="bds_renren" data-cmd="renren"></a><a href="#" class="bds_weixin" data-cmd="weixin"></a>
        <a href="#" data-cmd="weixin">2222</a>
    </div>
    <script>
    window._bd_share_config = { "common": { "bdSnsKey": {}, "bdText": "", "bdMini": "2", "bdPic": "", "bdStyle": "0", "bdSize": "16" }, "share": {}, "image": { "viewList": ["qzone", "tsina", "tqq", "renren", "weixin"], "viewText": "分享到：", "viewSize": "16" }, "selectShare": { "bdContainerClass": null, "bdSelectMiniList": ["qzone", "tsina", "tqq", "renren", "weixin"] } };
    with(document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
    </script>
</body>

</html>